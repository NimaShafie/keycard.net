<!-- Modules/Folio/Views/GuestDetailWindow.axaml -->
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:KeyCard.Desktop.Modules.Folio.ViewModels"
        mc:Ignorable="d"
        d:DesignWidth="1000" d:DesignHeight="700"
        Width="1000" Height="700"
        MinWidth="900" MinHeight="600"
        x:Class="KeyCard.Desktop.Modules.Folio.Views.GuestDetailWindow"
        x:DataType="vm:GuestDetailViewModel"
        Title="Guest Folio Details"
        Background="#2B2B33"
        Foreground="White">

  <Grid RowDefinitions="Auto,*,Auto" Margin="24">

    <!-- Header -->
    <Border Grid.Row="0"
            Background="#3B3B43"
            CornerRadius="8"
            Padding="20"
            Margin="0,0,0,16">
      <StackPanel>
        <TextBlock Text="{Binding GuestName}"
                   FontSize="24"
                   FontWeight="Bold"/>
        <StackPanel Orientation="Horizontal" Spacing="20" Margin="0,8,0,0">
          <TextBlock>
            <Run Text="Folio #: "/>
            <Run Text="{Binding FolioNumber}" FontWeight="SemiBold"/>
          </TextBlock>
          <TextBlock>
            <Run Text="Status: "/>
            <Run Text="{Binding Status}" FontWeight="SemiBold"/>
          </TextBlock>
          <TextBlock>
            <Run Text="Balance: "/>
            <Run Text="{Binding CurrentBalance, StringFormat=\{0:C\}}"
                 FontWeight="Bold"
                 Foreground="#FFD700"/>
          </TextBlock>
        </StackPanel>
      </StackPanel>
    </Border>

    <!-- Tabs Content -->
    <TabControl Grid.Row="1"
                Background="#2B2B33"
                SelectedIndex="{Binding SelectedTabIndex}">

      <!-- Charges Tab -->
      <TabItem Header="Charges">
        <Grid RowDefinitions="Auto,*,Auto" Margin="0,12,0,0">

          <!-- Guest Charges Section -->
          <TextBlock Grid.Row="0"
                     Text="Guest Charges"
                     FontSize="16"
                     FontWeight="SemiBold"
                     Margin="0,0,0,12"/>

          <!-- Charges DataGrid -->
          <Border Grid.Row="1"
                  Background="#1E1E26"
                  BorderBrush="#5C46A3"
                  BorderThickness="1"
                  CornerRadius="6"
                  ClipToBounds="True"
                  Margin="0,0,0,16">
            <DataGrid ItemsSource="{Binding Charges}"
                      AutoGenerateColumns="False"
                      HeadersVisibility="Column"
                      GridLinesVisibility="Horizontal"
                      IsReadOnly="True"
                      Background="Transparent"
                      BorderThickness="0">
              <DataGrid.Columns>
                <!-- ✅ FIX: Wider Date column (was too narrow) -->
                <DataGridTextColumn Header="Date"
                                    Binding="{Binding TransactionDate, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}"
                                    Width="160"/>
                <DataGridTextColumn Header="Description"
                                    Binding="{Binding Description}"
                                    Width="*"/>
                <DataGridTextColumn Header="Amount"
                                    Binding="{Binding Amount, StringFormat=\{0:C\}}"
                                    Width="120"/>

                <!-- ✅ FIX: Centered Remove button -->
                <DataGridTemplateColumn Header="Actions" Width="120">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <Button Content="Remove"
                              Background="#DC3545"
                              Foreground="White"
                              Padding="12,6"
                              CornerRadius="4"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Center"
                              Command="{Binding $parent[DataGrid].((vm:GuestDetailViewModel)DataContext).RemoveChargeCommand}"
                              CommandParameter="{Binding Id}"/>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
              </DataGrid.Columns>
            </DataGrid>
          </Border>

          <!-- Add New Charge Section -->
          <Border Grid.Row="2"
                  Background="#3B3B43"
                  BorderBrush="#5C46A3"
                  BorderThickness="1"
                  CornerRadius="6"
                  Padding="16">
            <StackPanel Spacing="12">
              <TextBlock Text="Add New Charge"
                         FontSize="14"
                         FontWeight="SemiBold"/>

              <Grid ColumnDefinitions="*,200,Auto">
                <TextBox Grid.Column="0"
                         Text="{Binding ChargeDescription}"
                         Watermark="Description (e.g., Room Service)"
                         Background="#1E1E26"
                         Foreground="White"
                         BorderBrush="#5C46A3"
                         CornerRadius="4"
                         Padding="10,8"
                         Height="36"
                         Margin="0,0,12,0"/>

                <TextBox Grid.Column="1"
                         Text="{Binding ChargeAmount}"
                         Watermark="Amount"
                         Background="#1E1E26"
                         Foreground="White"
                         BorderBrush="#5C46A3"
                         CornerRadius="4"
                         Padding="10,8"
                         Height="36"
                         Margin="0,0,12,0"/>

                <Button Grid.Column="2"
                        Content="Add Charge"
                        Command="{Binding AddChargeCommand}"
                        Background="#5C46A3"
                        Foreground="White"
                        Padding="20,8"
                        CornerRadius="4"
                        Height="36"/>
              </Grid>
            </StackPanel>
          </Border>
        </Grid>
      </TabItem>

      <!-- Payments Tab -->
      <TabItem Header="Payments">
        <Grid RowDefinitions="Auto,*,Auto" Margin="0,12,0,0">

          <TextBlock Grid.Row="0"
                     Text="Guest Payments"
                     FontSize="16"
                     FontWeight="SemiBold"
                     Margin="0,0,0,12"/>

          <!-- Payments DataGrid -->
          <Border Grid.Row="1"
                  Background="#1E1E26"
                  BorderBrush="#5C46A3"
                  BorderThickness="1"
                  CornerRadius="6"
                  ClipToBounds="True"
                  Margin="0,0,0,16">
            <DataGrid ItemsSource="{Binding Payments}"
                      AutoGenerateColumns="False"
                      HeadersVisibility="Column"
                      GridLinesVisibility="Horizontal"
                      IsReadOnly="True"
                      Background="Transparent"
                      BorderThickness="0">
              <DataGrid.Columns>
                <!-- ✅ FIX: Wider Date column -->
                <DataGridTextColumn Header="Date"
                                    Binding="{Binding TransactionDate, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}"
                                    Width="160"/>
                <DataGridTextColumn Header="Description"
                                    Binding="{Binding Description}"
                                    Width="*"/>
                <DataGridTextColumn Header="Amount"
                                    Binding="{Binding Amount, StringFormat=\{0:C\}}"
                                    Width="120"/>

                <!-- ✅ FIX: Centered Remove button -->
                <DataGridTemplateColumn Header="Actions" Width="120">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <Button Content="Remove"
                              Background="#DC3545"
                              Foreground="White"
                              Padding="12,6"
                              CornerRadius="4"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Center"
                              Command="{Binding $parent[DataGrid].((vm:GuestDetailViewModel)DataContext).RemovePaymentCommand}"
                              CommandParameter="{Binding Id}"/>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
              </DataGrid.Columns>
            </DataGrid>
          </Border>

          <!-- Add New Payment Section -->
          <Border Grid.Row="2"
                  Background="#3B3B43"
                  BorderBrush="#5C46A3"
                  BorderThickness="1"
                  CornerRadius="6"
                  Padding="16">
            <StackPanel Spacing="12">
              <TextBlock Text="Add New Payment"
                         FontSize="14"
                         FontWeight="SemiBold"/>

              <Grid ColumnDefinitions="*,200,Auto">
                <ComboBox Grid.Column="0"
                          SelectedItem="{Binding PaymentMethod}"
                          ItemsSource="{Binding PaymentMethods}"
                          PlaceholderText="Select payment method"
                          Background="#1E1E26"
                          Foreground="White"
                          BorderBrush="#5C46A3"
                          CornerRadius="4"
                          Padding="10,8"
                          Height="36"
                          Margin="0,0,12,0"/>

                <TextBox Grid.Column="1"
                         Text="{Binding PaymentAmount}"
                         Watermark="Amount"
                         Background="#1E1E26"
                         Foreground="White"
                         BorderBrush="#5C46A3"
                         CornerRadius="4"
                         Padding="10,8"
                         Height="36"
                         Margin="0,0,12,0"/>

                <Button Grid.Column="2"
                        Content="Add Payment"
                        Command="{Binding AddPaymentCommand}"
                        Background="#5C46A3"
                        Foreground="White"
                        Padding="20,8"
                        CornerRadius="4"
                        Height="36"/>
              </Grid>
            </StackPanel>
          </Border>
        </Grid>
      </TabItem>

      <!-- Audit Log Tab -->
      <TabItem Header="Audit Log">
        <Border Background="#1E1E26"
                BorderBrush="#5C46A3"
                BorderThickness="1"
                CornerRadius="6"
                ClipToBounds="True"
                Margin="0,12,0,0">
          <DataGrid ItemsSource="{Binding AuditLog}"
                    AutoGenerateColumns="False"
                    HeadersVisibility="Column"
                    GridLinesVisibility="Horizontal"
                    IsReadOnly="True"
                    Background="Transparent"
                    BorderThickness="0">
            <DataGrid.Columns>
              <DataGridTextColumn Header="Timestamp"
                                  Binding="{Binding Timestamp, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}"
                                  Width="160"/>
              <DataGridTextColumn Header="Action"
                                  Binding="{Binding Action}"
                                  Width="150"/>
              <DataGridTextColumn Header="Description"
                                  Binding="{Binding Description}"
                                  Width="*"/>
              <DataGridTextColumn Header="User"
                                  Binding="{Binding User}"
                                  Width="150"/>
            </DataGrid.Columns>
          </DataGrid>
        </Border>
      </TabItem>
    </TabControl>

    <!-- ✅ FIX: Footer with proper spacing for Close button -->
    <Grid Grid.Row="2" Margin="0,16,0,0">
      <StackPanel HorizontalAlignment="Left" VerticalAlignment="Center">
        <TextBlock Text="Changes are saved automatically"
                   FontSize="12"
                   Foreground="#999"
                   Margin="0,0,0,4"/>
      </StackPanel>

      <!-- ✅ FIX: Close button with proper height to prevent cutoff -->
      <Button HorizontalAlignment="Right"
              Content="Close"
              Command="{Binding CloseCommand}"
              CommandParameter="{Binding $parent[Window]}"
              Background="#6C757D"
              Foreground="White"
              Padding="24,10"
              CornerRadius="4"
              FontSize="14"
              Height="40"
              MinWidth="100"/>
    </Grid>
  </Grid>
</Window>

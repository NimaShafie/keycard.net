@page "/dashboard"
@inject NavigationManager Nav
@inject IHttpClientFactory Http
@inject KeyCard.Web.Services.AuthStateService AuthState
@inject IJSRuntime JS

<div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 py-10 px-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">My Bookings</h1>
                <p class="text-slate-500">Welcome back! Here are your reservations.</p>
            </div>
            <button @onclick="NewBooking"
                    class="px-6 py-2 bg-amber-500 text-white font-semibold rounded-xl hover:bg-amber-600 transition flex items-center gap-2">
                <span>+</span> New Booking
            </button>
        </div>

        <!-- Loading State -->
        @if (IsLoading)
        {
            <div class="flex items-center justify-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500"></div>
            </div>
        }
        else if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="bg-white rounded-3xl shadow-lg p-10 text-center">
                <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                <h3 class="text-lg font-semibold text-slate-700">Error Loading Bookings</h3>
                <p class="text-slate-500 mt-2">@ErrorMessage</p>
                <button class="mt-6 px-6 py-2 bg-amber-500 text-white rounded-xl hover:bg-amber-600"
                        @onclick="LoadBookings">
                    Try Again
                </button>
            </div>
        }
        else if (Bookings.Count == 0)
        {
            <div class="bg-white rounded-3xl shadow-lg p-10 text-center">
                <div class="text-6xl mb-4">üè®</div>
                <h3 class="text-xl font-semibold text-slate-700">No Bookings Yet</h3>
                <p class="text-slate-500 mt-2">Ready to plan your next stay?</p>
                <button @onclick="NewBooking"
                        class="mt-6 px-8 py-3 bg-amber-500 text-white font-semibold rounded-xl hover:bg-amber-600 transition">
                    Make a Reservation
                </button>
            </div>
        }
        else
        {
            <!-- Booking Tabs -->
            <div class="flex gap-2 mb-6">
                <button @onclick="@(() => FilterStatus = null)"
                        class="@GetTabClass(null)">
                    All (@Bookings.Count)
                </button>
                <button @onclick="@(() => FilterStatus = "Reserved")"
                        class="@GetTabClass("Reserved")">
                    Upcoming (@Bookings.Count(b => b.StatusName == "Reserved"))
                </button>
                <button @onclick="@(() => FilterStatus = "CheckedIn")"
                        class="@GetTabClass("CheckedIn")">
                    Active (@Bookings.Count(b => b.StatusName == "CheckedIn"))
                </button>
                <button @onclick="@(() => FilterStatus = "CheckedOut")"
                        class="@GetTabClass("CheckedOut")">
                    Past (@Bookings.Count(b => b.StatusName == "CheckedOut"))
                </button>
            </div>

            <!-- Bookings List -->
            <div class="space-y-4">
                @foreach (var booking in FilteredBookings)
                {
                    <div class="bg-white rounded-2xl shadow-md overflow-hidden hover:shadow-lg transition">
                        <div class="flex">
                            <!-- Status Indicator -->
                            <div class="@GetStatusClass(booking.StatusName) w-2"></div>

                            <!-- Content -->
                            <div class="flex-1 p-5">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <div class="flex items-center gap-3 mb-2">
                                            <span class="@GetStatusBadgeClass(booking.StatusName) text-xs px-2 py-1 rounded-full">
                                                @GetStatusLabel(booking.StatusName)
                                            </span>
                                            <span class="font-mono text-sm text-slate-500">@booking.ConfirmationCode</span>
                                        </div>
                                        <h3 class="text-lg font-semibold text-slate-900">Room @booking.RoomNumber</h3>
                                        <p class="text-slate-500 text-sm mt-1">
                                            @booking.CheckInDate.ToString("MMM dd") - @booking.CheckOutDate.ToString("MMM dd, yyyy")
                                        </p>
                                    </div>
                                    <div class="text-right flex items-center gap-4">
                                        @if (booking.StatusName == "CheckedIn" && booking.DigitalKey != null)
                                        {
                                            <div class="bg-white border-2 border-amber-400 rounded-lg p-1" title="Digital Room Key">
                                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=60x60&data=@Uri.EscapeDataString(booking.DigitalKey.Token)" 
                                                     alt="Room Key" class="w-14 h-14" />
                                            </div>
                                        }
                                        <div>
                                            <p class="text-2xl font-bold text-slate-900">$@booking.TotalAmount.ToString("0")</p>
                                            <p class="text-xs text-slate-500">@GetNights(booking) nights</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="flex gap-3 mt-4 pt-4 border-t border-slate-100">
                                    <button @onclick="@(() => ViewDetails(booking.Id))"
                                            class="px-4 py-2 text-sm border border-slate-200 rounded-lg hover:bg-slate-50 transition">
                                        View Details
                                    </button>

                                    @if (booking.StatusName == "Reserved" && booking.CheckInDate.Date <= DateTime.Today)
                                    {
                                        <button @onclick="@(() => CheckIn(booking.Id))"
                                                class="px-4 py-2 text-sm bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition">
                                            Check In Now
                                        </button>
                                    }

                                    @if (booking.StatusName == "CheckedIn")
                                    {
                                        <button @onclick="@(() => CheckOut(booking.Id))"
                                                class="px-4 py-2 text-sm bg-rose-500 text-white rounded-lg hover:bg-rose-600 transition">
                                            üö™ Check Out
                                        </button>
                                    }

                                    @if (booking.StatusName == "CheckedOut")
                                    {
                                        <button @onclick="@(() => DownloadInvoice(booking.Id))"
                                                class="px-4 py-2 text-sm border border-slate-200 rounded-lg hover:bg-slate-50 transition flex items-center gap-1">
                                            üìÑ Invoice
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Logout -->
        <div class="mt-8 text-center">
            <button @onclick="Logout" class="text-slate-500 hover:text-slate-700 text-sm">
                Sign Out
            </button>
        </div>
    </div>
</div>

@code {
    private List<BookingDto> Bookings { get; set; } = new();
    private string? FilterStatus { get; set; }
    private bool IsLoading { get; set; } = true;
    private string? ErrorMessage { get; set; }

    private IEnumerable<BookingDto> FilteredBookings =>
        FilterStatus == null ? Bookings : Bookings.Where(b => b.StatusName == FilterStatus);

    protected override async Task OnInitializedAsync()
    {
        if (!AuthState.IsAuthenticated)
        {
            Nav.NavigateTo("/auth/login");
            return;
        }

        await LoadBookings();
    }

    private async Task LoadBookings()
    {
        IsLoading = true;
        ErrorMessage = null;

        try
        {
            var client = Http.CreateClient("api");
            client.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", AuthState.Token);

            var response = await client.GetAsync("/api/guest/bookings");

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<ApiResponse<List<BookingDto>>>();
                Bookings = apiResponse?.Result ?? new();
                Bookings = Bookings.OrderByDescending(b => b.CheckInDate).ToList();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                AuthState.Clear();
                Nav.NavigateTo("/auth/login");
            }
            else
            {
                ErrorMessage = "Failed to load bookings.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task CheckIn(int bookingId)
    {
        try
        {
            var client = Http.CreateClient("api");
            client.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", AuthState.Token);

            var response = await client.PostAsync($"/api/guest/bookings/{bookingId}/checkin", null);

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<ApiResponse<BookingDto>>();
                var updatedBooking = apiResponse?.Result;
                if (updatedBooking != null)
                {
                    // Update the booking in the list
                    var index = Bookings.FindIndex(b => b.Id == bookingId);
                    if (index >= 0)
                    {
                        Bookings[index] = updatedBooking;
                    }
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                ErrorMessage = "Check-in failed. Please try again or visit the front desk.";
            }
        }
        catch
        {
            ErrorMessage = "Unable to process check-in.";
        }
    }

    private async Task CheckOut(int bookingId)
    {
        try
        {
            var client = Http.CreateClient("api");
            client.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", AuthState.Token);

            var response = await client.PostAsync($"/api/guest/bookings/{bookingId}/checkout", null);

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<ApiResponse<BookingDto>>();
                var updatedBooking = apiResponse?.Result;
                if (updatedBooking != null)
                {
                    // Update the booking in the list
                    var index = Bookings.FindIndex(b => b.Id == bookingId);
                    if (index >= 0)
                    {
                        Bookings[index] = updatedBooking;
                    }
                }
            }
            else
            {
                ErrorMessage = "Check-out failed. Please try again or visit the front desk.";
            }
        }
        catch
        {
            ErrorMessage = "Unable to process check-out.";
        }
    }

    private void ViewDetails(int bookingId)
    {
        Nav.NavigateTo($"/booking/{bookingId}");
    }

    private async Task DownloadInvoice(int bookingId)
    {
        try
        {
            var client = Http.CreateClient("api");
            client.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", AuthState.Token);

            var response = await client.GetAsync($"/api/guest/bookings/{bookingId}/invoice");

            if (response.IsSuccessStatusCode)
            {
                var pdfBytes = await response.Content.ReadAsByteArrayAsync();
                var base64 = Convert.ToBase64String(pdfBytes);
                var fileName = $"Invoice-{bookingId}.pdf";
                
                // Use JS to trigger download
                await JS.InvokeVoidAsync("downloadFile", base64, fileName, "application/pdf");
            }
            else
            {
                ErrorMessage = "Failed to download invoice.";
            }
        }
        catch
        {
            ErrorMessage = "Unable to download invoice.";
        }
    }

    private void NewBooking() => Nav.NavigateTo("/dates");
    private void Logout()
    {
        AuthState.Clear();
        Nav.NavigateTo("/");
    }

    private int GetNights(BookingDto booking) =>
        (booking.CheckOutDate.Date - booking.CheckInDate.Date).Days;

    private string GetTabClass(string? status) =>
        FilterStatus == status
            ? "px-4 py-2 text-sm font-medium bg-slate-900 text-white rounded-lg"
            : "px-4 py-2 text-sm text-slate-600 hover:bg-slate-200 rounded-lg transition";

    private string GetStatusClass(string status) => status switch
    {
        "Reserved" => "bg-blue-500",
        "CheckedIn" => "bg-emerald-500",
        "CheckedOut" => "bg-slate-400",
        "Cancelled" => "bg-red-500",
        _ => "bg-slate-400"
    };

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Reserved" => "bg-blue-100 text-blue-700",
        "CheckedIn" => "bg-emerald-100 text-emerald-700",
        "CheckedOut" => "bg-slate-100 text-slate-600",
        "Cancelled" => "bg-red-100 text-red-700",
        _ => "bg-slate-100 text-slate-600"
    };

    private string GetStatusLabel(string status) => status switch
    {
        "Reserved" => "Upcoming",
        "CheckedIn" => "Checked In",
        "CheckedOut" => "Completed",
        "Cancelled" => "Cancelled",
        _ => status
    };

    private class ApiResponse<T>
    {
        public string Message { get; set; } = "";
        public T? Result { get; set; }
        public int StatusCode { get; set; }
    }

    private class BookingDto
    {
        public int Id { get; set; }
        public string ConfirmationCode { get; set; } = "";
        public DateTime CheckInDate { get; set; }
        public DateTime CheckOutDate { get; set; }
        public int Status { get; set; }  // Enum: 0=Reserved, 1=CheckedIn, 2=CheckedOut, 3=Cancelled
        public string GuestName { get; set; } = "";
        public string RoomNumber { get; set; } = "";
        public decimal TotalAmount { get; set; }
        public DigitalKeyDto? DigitalKey { get; set; }
        
        public string StatusName => Status switch
        {
            0 => "Reserved",
            1 => "CheckedIn",
            2 => "CheckedOut",
            3 => "Cancelled",
            _ => "Unknown"
        };
    }

    private class DigitalKeyDto
    {
        public int Id { get; set; }
        public string Token { get; set; } = "";
        public DateTime IssuedAt { get; set; }
        public DateTime ExpiresAt { get; set; }
        public bool IsRevoked { get; set; }
    }
}

